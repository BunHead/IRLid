<!DOCTYPE html>
<html lang="en">

<!-- New Deploy 1 -->
  
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>IRLid – Application (Camera Debug)</title>

  <link rel="stylesheet" href="css/style.css">

  <style>
    /* Ensure scanner area is always visible */
    #scanner {
      width: 320px;
      height: 320px;
      margin: 16px auto;
      border: 2px dashed #999;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      background: #f8f8f8;
    }

    /* Keep button clickable */
    #startCamBtn {
      position: relative;
      z-index: 9999;
      touch-action: manipulation;
      user-select: none;
    }

    #debug {
      max-width: 820px;
      margin: 12px auto 24px;
      text-align: left;
      white-space: pre-wrap;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 12px;
      border: 1px solid #ddd;
      padding: 10px;
      border-radius: 10px;
      background: #fff;
      color: #111;
    }

    .small {
      max-width: 820px;
      margin: 10px auto;
      padding: 0 12px;
    }
  </style>
</head>

<body>
<header>
  <img src="logo.png" alt="In Real Life ID Logo" id="logo">
  <nav>
    <ul class="navbar">
      <li><a href="index.html">Home</a></li>
      <li><a href="application.html">Application</a></li>
      <li><a href="receipt.html">Receipt</a></li>
    </ul>
  </nav>
</header>

<main>
  <h2>Application (Camera Debug)</h2>

  <p class="small" id="status">
    Tap <b>Start Camera</b>. This page will show exactly what happens.
  </p>

  <div class="small" style="text-align:center;">
    <button class="btn" id="startCamBtn" type="button">Start Camera</button>
  </div>

  <div id="scanner">
    <span id="scannerHint">Camera preview should appear here</span>
  </div>

  <div id="debug">Loading debug…</div>
</main>

<footer>
  IRLid — Proof of Personhood (Demo)
</footer>

<!-- QR scanner library -->
<script src="https://unpkg.com/html5-qrcode"></script>

<script>
  const statusEl = document.getElementById("status");
  const debugEl  = document.getElementById("debug");
  const startBtn = document.getElementById("startCamBtn");
  const hintEl   = document.getElementById("scannerHint");

  function now() {
    return new Date().toISOString();
  }

  function log(...args) {
    const line = args.map(a => (typeof a === "string" ? a : JSON.stringify(a, null, 2))).join(" ");
    debugEl.textContent += "\n" + line;
  }

  function setStatus(msg) {
    statusEl.textContent = msg;
    log(now(), "STATUS:", msg);
  }

  // Global error visibility (mobile-friendly)
  window.addEventListener("error", (e) => {
    log(now(), "WINDOW ERROR:", e.message || String(e));
  });
  window.addEventListener("unhandledrejection", (e) => {
    const r = e.reason;
    log(now(), "UNHANDLED REJECTION:", (r && (r.message || r.name || r)) || String(e));
  });

  // Initialize debug
  debugEl.textContent = "";
  log(now(), "Loaded:", location.href);
  log(now(), "UserAgent:", navigator.userAgent);
  log(now(), "SecureContext:", window.isSecureContext);
  log(now(), "Protocol:", location.protocol);

  const libLoaded = (typeof Html5Qrcode !== "undefined");
  log(now(), "Html5Qrcode present:", libLoaded);

  // Tap counter to prove the button is actually receiving events
  let taps = 0;
  function bumpTap(kind) {
    taps += 1;
    startBtn.textContent = `Tapped (${taps})`;
    startBtn.style.transform = "scale(1.03)";
    setTimeout(() => startBtn.style.transform = "scale(1)", 120);
    log(now(), "TAP REGISTERED:", kind, "count=", taps);
  }

  let qr = null;
  let running = false;

  async function stopCamera() {
    try {
      if (qr && running) {
        await qr.stop();
        await qr.clear();
      }
    } catch (e) {
      log(now(), "Stop error:", e);
    } finally {
      running = false;
      qr = null;
    }
  }

  async function startCamera() {
    try {
      if (!libLoaded) {
        setStatus("ERROR: html5-qrcode did not load. (unpkg blocked or offline)");
        log(now(), "Try: disable adblock / private DNS / VPN, try Incognito, or change network.");
        startBtn.disabled = false;
        return;
      }

      if (!window.isSecureContext) {
        setStatus("ERROR: Not a secure context. Camera requires HTTPS.");
        log(now(), "Check you are on https://bunhead.github.io/IRLid/...");
        startBtn.disabled = false;
        return;
      }

      if (running) {
        setStatus("Camera already running.");
        startBtn.disabled = false;
        return;
      }

      setStatus("Requesting camera permission / listing cameras…");

      // Enumerate cameras
      const cams = await Html5Qrcode.getCameras();
      log(now(), "Cameras found:", cams);

      if (!cams || cams.length === 0) {
        setStatus("No cameras detected by the browser.");
        startBtn.disabled = false;
        return;
      }

      // Choose camera: prefer rear camera if label indicates, else last
      let camId = cams[cams.length - 1].id;
      for (const c of cams) {
        const lbl = (c.label || "").toLowerCase();
        if (lbl.includes("back") || lbl.includes("rear") || lbl.includes("environment")) {
          camId = c.id;
          break;
        }
      }
      log(now(), "Using camera id:", camId);

      // Clear hint text and start
      hintEl.textContent = "";
      qr = new Html5Qrcode("scanner");
      running = true;

      await qr.start(
        { deviceId: { exact: camId } },
        { fps: 10, qrbox: 250 },
        async (decodedText) => {
          setStatus("QR scanned ✅");
          log(now(), "SCANNED:", decodedText);

          // Stop after first successful scan
          await stopCamera();
          startBtn.disabled = false;
          startBtn.textContent = "Start Camera";
        },
        (err) => {
          // ignore scan errors, they occur continuously while scanning
        }
      );

      setStatus("Camera started. Point at a QR code.");
      startBtn.disabled = true;

    } catch (e) {
      running = false;
      const msg = (e && (e.message || e.name)) ? (e.message || e.name) : String(e);
      setStatus("Camera failed: " + msg);
      log(now(), "FULL ERROR:", e);

      startBtn.disabled = false;
      startBtn.textContent = "Start Camera";
    }
  }

  function wireButton() {
    // click
    startBtn.addEventListener("click", async () => {
      bumpTap("click");
      await startCamera();
    });

    // touchend (some mobile cases)
    startBtn.addEventListener("touchend", async (ev) => {
      bumpTap("touchend");
      ev.preventDefault();
      await startCamera();
    }, { passive: false });

    log(now(), "Button wired.");
  }

  // Wire ASAP
  wireButton();
  setStatus("Ready. Tap Start Camera.");

</script>
</body>
</html>

