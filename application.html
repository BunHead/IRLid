<!DOCTYPE html>
<!-- Deploy 13 -->
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>IRLid — Scan</title>
  <link rel="stylesheet" href="css/style.css">

  <style>
    :root{
      --black:#000;
      --white:#fff;
      --mobile-nav-h: 124px;
      --side-pad: 12px;
      --top-gap: 10px;
    }

    html, body { height: 100%; }
    body{
      margin: 0;
      background: #fff;
      overflow-x: hidden;
    }

    /* ===== Header / Desktop nav ===== */
    header.site-header{ width:100%; background:#fff; }
    .brand-wrap{ width:100%; padding:10px 14px 0 14px; }
    .brand{ display:inline-flex; align-items:center; text-decoration:none; color:inherit; }

    nav.site-nav{
      width:100%;
      background:var(--black);
      display:flex;
      align-items:center;
      justify-content:flex-start;
      gap:0;
      padding:0;
      margin:0;
      position:sticky;
      top:0;
      z-index:1000;
    }

    a.nav-btn, summary.nav-btn{
      appearance:none; -webkit-appearance:none;
      border:0;
      background:var(--black);
      color:var(--white);
      text-decoration:none;
      font:inherit;
      font-weight:700;
      border-radius:0;
      margin:0;
      padding:10px 12px;
      line-height:1;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      user-select:none;
      white-space:nowrap;
    }
    a.nav-btn:hover, summary.nav-btn:hover{ background:#111; }
    a.nav-btn:active, summary.nav-btn:active{ background:#222; }
    a.nav-btn:focus, summary.nav-btn:focus{ outline:2px solid #555; outline-offset:-2px; }

    details.nav-dropdown{ position:relative; }
    details.nav-dropdown > summary{ list-style:none; }
    details.nav-dropdown > summary::-webkit-details-marker{ display:none; }

    .dropdown-menu{
      position:absolute;
      top:100%;
      left:0;
      background:#fff;
      border:1px solid #ddd;
      border-radius:0;
      padding:0;
      min-width:220px;
      z-index:1200;
    }
    .dropdown-menu a{
      display:block;
      padding:12px 12px;
      text-decoration:none;
      color:#000;
      font-weight:700;
      border-radius:0;
      margin:0;
    }
    .dropdown-menu a:hover{ background:#f2f2f2; }

    /* ===== Page layout ===== */
    main.page-main{
      max-width: 980px;
      margin: 0 auto;
      padding: var(--top-gap) var(--side-pad) 18px var(--side-pad);
      box-sizing: border-box;
    }

    #scanner{
      width: min(92vw, 460px);
      height: min(92vw, 460px);
      margin: 14px auto 8px;
      border: 2px dashed #999;
      border-radius: 0;
      overflow: hidden;
      background: #f8f8f8;
      display:flex;
      align-items:center;
      justify-content:center;
      box-sizing: border-box;
    }

    .controls{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      justify-content:center;
      margin-top: 10px;
      margin-bottom: 8px;
    }
    .controls .btn{ min-width: 160px; }

    .small{
      margin: 8px auto 0;
      text-align:center;
      box-sizing:border-box;
    }

    #responseArea{
      display:none;
      text-align:center;
      margin-top: 12px;
    }

    #checksArea{
      display:none;
      margin: 10px auto 0;
      max-width: 560px;
      border: 1px solid #ddd;
      padding: 10px;
      border-radius: 0;
      box-sizing: border-box;
      font-family: ui-monospace, monospace;
      white-space: pre-wrap;
      background: #fff;
    }

    #debug{
      white-space: pre-wrap;
      font-family: ui-monospace, monospace;
      font-size: 12px;
      border: 1px solid #ddd;
      padding: 10px;
      border-radius: 0;
      background: #fff;
      margin: 12px auto 0;
      box-sizing: border-box;
    }

    /* Hide file inputs but keep accessible via button click */
    .file-input{
      position:absolute;
      left:-9999px;
      width:1px;
      height:1px;
      overflow:hidden;
    }

    /* ===== Mobile bottom 2x2 nav ===== */
    @media (max-width: 720px){
      :root{ --top-gap: 6px; }

      .brand-wrap{ padding:4px var(--side-pad) 0 var(--side-pad); }
      #logo{
        max-width:72vw;
        max-height:90px;
        width:auto;
        height:auto;
        display:block;
      }

      nav.site-nav{
        position:fixed;
        top:auto;
        bottom: env(safe-area-inset-bottom, 0px);
        left:0;
        right:0;
        height: var(--mobile-nav-h);
        display:grid;
        grid-template-columns: 1fr 1fr;
        grid-template-rows: 1fr 1fr;
        gap:0;
        margin:0;
        padding:0;
        background:var(--black);
      }

      a.nav-btn, summary.nav-btn{
        width:100%;
        height:100%;
        padding:0;
        border-radius:0;
        font-size:18px;
      }

      .dropdown-menu{
        position:fixed;
        left:0;
        right:0;
        bottom: calc(var(--mobile-nav-h) + env(safe-area-inset-bottom, 0px));
        top:auto;
        border-radius:0;
      }

      body{
        padding-bottom: calc(var(--mobile-nav-h) + env(safe-area-inset-bottom, 0px));
      }
    }
  </style>
</head>

<body>
  <header class="site-header">
    <div class="brand-wrap">
      <a class="brand" href="index.html" aria-label="IRLid Home">
        <img src="logo.png" alt="IRLid Logo" id="logo">
      </a>
    </div>

    <nav class="site-nav" aria-label="Primary">
      <a class="nav-btn" href="index.html">Home</a>
      <a class="nav-btn" href="application.html">Scan</a>

      <details class="nav-dropdown">
        <summary class="nav-btn">About ▼</summary>
        <div class="dropdown-menu" role="menu" aria-label="About menu">
          <a href="about.html">About</a>
          <a href="features.html">Features</a>
          <a href="contact.html">Contact</a>
        </div>
      </details>

      <a class="nav-btn" href="receipt.html">Receipts</a>
    </nav>
  </header>

  <main class="page-main">
    <p id="status" class="small">Ready.</p>

    <div class="controls">
      <button class="btn" id="startBtn">Start Scanner</button>
      <button class="btn secondary" id="stopBtn">Stop</button>
      <button class="btn" id="scanHelloPhotoBtn">Scan HELLO Photo</button>
    </div>

    <div id="scanner"></div>

    <div class="small">
      <label for="cameraSelect"><b>Camera:</b></label><br>
      <select id="cameraSelect"></select>
    </div>

    <div id="responseArea">
      <h3>Your Response QR</h3>
      <div class="qr-box" id="responseQr"></div>
      <div class="controls">
        <button class="btn secondary" id="scanResponseBtn">Scan Their Response</button>
        <button class="btn" id="scanResponsePhotoBtn">Scan Response Photo</button>
      </div>
    </div>

    <div id="checksArea"></div>

    <div id="debug">Debug log…</div>

    <!-- Hidden file inputs -->
    <input class="file-input" id="helloFile" type="file" accept="image/*">
    <input class="file-input" id="responseFile" type="file" accept="image/*">
  </main>

  <script src="js/sign.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
  <script src="https://unpkg.com/html5-qrcode"></script>
  <script src="js/qr.js?v=layout7"></script>

  <script>
    const statusEl = document.getElementById("status");
    const debugEl = document.getElementById("debug");
    const cameraSelect = document.getElementById("cameraSelect");
    const responseArea = document.getElementById("responseArea");
    const checksArea = document.getElementById("checksArea");
    const startBtn = document.getElementById("startBtn");
    const stopBtn = document.getElementById("stopBtn");
    const scanResponseBtn = document.getElementById("scanResponseBtn");
    const scanHelloPhotoBtn = document.getElementById("scanHelloPhotoBtn");
    const scanResponsePhotoBtn = document.getElementById("scanResponsePhotoBtn");
    const helloFile = document.getElementById("helloFile");
    const responseFile = document.getElementById("responseFile");

    function log(...args) {
      console.log(...args);
      debugEl.textContent += "\n" + args.map(a => (typeof a === "string" ? a : JSON.stringify(a, null, 2))).join(" ");
    }
    function setStatus(s) { statusEl.textContent = s; }

    let scanner = null;
    let currentHello = null;

    // We store "my response" (created after scanning HELLO) so we can compare it against
    // the other person's response for time + location checks.
    let myResponse = null;

    async function listCameras() {
      try {
        const devices = await Html5Qrcode.getCameras();
        cameraSelect.innerHTML = "";
        devices.forEach((d, idx) => {
          const opt = document.createElement("option");
          opt.value = d.id;
          opt.textContent = d.label || `Camera ${idx + 1}`;
          cameraSelect.appendChild(opt);
        });
        return devices;
      } catch (e) {
        log("Camera list error:", String(e));
        return [];
      }
    }

    async function stopScanner() {
      try {
        if (scanner) {
          await scanner.stop();
          await scanner.clear();
          scanner = null;
        }
      } catch (e) {
        log("Stop error:", String(e));
      }
    }

    async function startScanner(onText) {
      await stopScanner();
      scanner = new Html5Qrcode("scanner");
      const cameraId = cameraSelect.value || { facingMode: "environment" };
      const config = { fps: 10, qrbox: 320 };

      try {
        await scanner.start(
          cameraId,
          config,
          (decodedText) => onText(decodedText),
          () => {}
        );
      } catch (e) {
        log("Start error:", String(e));
        setStatus("Scanner failed to start.");
      }
    }

    // ===== Scan-from-photo support =====
    async function scanFromPhoto(file) {
      if (!file) throw new Error("No file selected.");
      if (typeof Html5Qrcode === "undefined") throw new Error("Html5Qrcode not loaded.");

      await stopScanner();

      // Use a fresh instance tied to #scanner (required by the library)
      const q = new Html5Qrcode("scanner");
      try {
        const decodedText = await q.scanFile(file, true);
        return decodedText;
      } finally {
        try { await q.clear(); } catch {}
      }
    }

    function tryParseHelloFromUrlHash() {
      const hash = location.hash || "";
      const match = hash.match(/HELLO=([A-Za-z0-9\-_]+)/);
      if (!match) return null;
      try {
        const bytes = b64urlDecode(match[1]);
        return JSON.parse(new TextDecoder().decode(bytes));
      } catch (e) {
        log("HELLO parse error:", String(e));
        return null;
      }
    }

    async function getGPS() {
      return new Promise((resolve) => {
        if (!navigator.geolocation) return resolve(null);
        navigator.geolocation.getCurrentPosition(
          (pos) => resolve({ lat: pos.coords.latitude, lon: pos.coords.longitude, acc: pos.coords.accuracy }),
          () => resolve(null),
          { enableHighAccuracy: true, timeout: 6000, maximumAge: 0 }
        );
      });
    }

    // Haversine distance in metres
    function distanceMeters(a, b) {
      const R = 6371000;
      const toRad = (x) => (x * Math.PI) / 180;
      const dLat = toRad(b.lat - a.lat);
      const dLon = toRad(b.lon - a.lon);
      const lat1 = toRad(a.lat);
      const lat2 = toRad(b.lat);

      const s =
        Math.sin(dLat / 2) * Math.sin(dLat / 2) +
        Math.cos(lat1) * Math.cos(lat2) * Math.sin(dLon / 2) * Math.sin(dLon / 2);

      return 2 * R * Math.asin(Math.sqrt(s));
    }

    function showChecks(text) {
      checksArea.style.display = "block";
      checksArea.textContent = text;
    }

    function clearChecks() {
      checksArea.style.display = "none";
      checksArea.textContent = "";
    }

    async function handleHello(text) {
      try {
        clearChecks();

        let hello = null;

        // Try URL form
        try {
          const u = new URL(text);
          const m = (u.hash || "").match(/HELLO=([A-Za-z0-9\-_]+)/);
          if (m) {
            const bytes = b64urlDecode(m[1]);
            hello = JSON.parse(new TextDecoder().decode(bytes));
          }
        } catch {}

        // Try raw base64url form
        if (!hello) {
          try {
            const bytes = b64urlDecode(text);
            hello = JSON.parse(new TextDecoder().decode(bytes));
          } catch {}
        }

        if (!hello || hello.type !== "hello") {
          setStatus("Not a HELLO QR. Try again.");
          return;
        }

        currentHello = hello;
        setStatus("HELLO scanned. Creating response…");

        const myPub = await getPublicJwk();
        const ordered = [myPub, hello.pub].sort((a, b) => JSON.stringify(a).localeCompare(JSON.stringify(b)));

        const gps = await getGPS();
        const ts = Math.floor(Date.now() / 1000);

        const payload = { v: 1, type: "meeting", pubs: ordered, gps, ts };

        const payloadBytes = new TextEncoder().encode(JSON.stringify(payload));
        const hash = await sha256(payloadBytes);
        const sig = await signBytes(hash);

        const response = {
          v: 1,
          type: "response",
          payload,
          hash: b64urlEncode(new Uint8Array(hash)),
          sig,
          pub: myPub
        };

        // Store my response for later verification
        myResponse = response;

        const encoded = b64urlEncode(new TextEncoder().encode(JSON.stringify(response)));
        makeQR("responseQr", encoded, 360);

        responseArea.style.display = "block";
        setStatus("Response created. Show it to the other person.");
        log("Response created:", response);
      } catch (e) {
        log("handleHello error:", String(e));
        setStatus("Error creating response.");
      } finally {
        await stopScanner();
      }
    }

    async function handleResponse(text) {
      try {
        clearChecks();

        setStatus("Response scanned. Verifying…");

        let response = null;
        try {
          const bytes = b64urlDecode(text);
          response = JSON.parse(new TextDecoder().decode(bytes));
        } catch {}

        if (!response || response.type !== "response") {
          setStatus("Not a response QR. Try again.");
          return;
        }

        // Require we have our own response (so we can compare time+GPS)
        if (!myResponse || !myResponse.payload) {
          showChecks(
            "Verification unavailable:\n" +
            "- You have not generated 'Your Response' yet.\n\n" +
            "Flow:\n" +
            "1) Scan HELLO (camera or photo)\n" +
            "2) Then scan their Response"
          );
          setStatus("Generate your Response first.");
          return;
        }

        const a = myResponse.payload;      // "my response" payload (device A)
        const b = response.payload;        // other person's response payload (device B)

        // 1) time check (within 60 seconds)
        const timeDiff = Math.abs((a.ts || 0) - (b.ts || 0));
        const timeOk = timeDiff <= 60;

        // 2) location check (within 2 metres)
        let locOk = false;
        let dist = null;

        if (a.gps && b.gps && typeof a.gps.lat === "number" && typeof a.gps.lon === "number" &&
            typeof b.gps.lat === "number" && typeof b.gps.lon === "number") {
          dist = distanceMeters({ lat: a.gps.lat, lon: a.gps.lon }, { lat: b.gps.lat, lon: b.gps.lon });
          locOk = dist <= 2;
        }

        const lines = [];
        lines.push("Verification:");
        lines.push(`- Time difference: ${timeDiff}s (must be ≤ 60s) => ${timeOk ? "PASS" : "FAIL"}`);

        if (dist === null) {
          lines.push(`- Location distance: unavailable (missing GPS on one device) => FAIL`);
        } else {
          lines.push(`- Location distance: ${dist.toFixed(2)}m (must be ≤ 2.00m) => ${locOk ? "PASS" : "FAIL"}`);
        }

        // If either fails, do not save receipt
        if (!timeOk || !locOk) {
          showChecks(lines.join("\n"));
          setStatus("Verification failed. Receipt NOT saved.");
          log("Verification failed:", { timeDiff, dist, myPayload: a, theirPayload: b });
          return;
        }

        // Save receipt (other person's response)
        localStorage.setItem("irlid_last_receipt", JSON.stringify(response));
        showChecks(lines.join("\n"));
        setStatus("Verified ✅ Receipt saved. Open Receipts to view.");
        log("Saved receipt:", response);

      } catch (e) {
        log("handleResponse error:", String(e));
        setStatus("Error reading response.");
      } finally {
        await stopScanner();
      }
    }

    // ===== UI Wiring =====
    startBtn.onclick = async () => {
      setStatus("Starting scanner…");
      await startScanner(handleHello);
      setStatus("Scan the other person's HELLO QR.");
    };

    stopBtn.onclick = async () => {
      await stopScanner();
      setStatus("Stopped.");
    };

    scanResponseBtn.onclick = async () => {
      setStatus("Starting scanner for their Response…");
      await startScanner(handleResponse);
      setStatus("Scan their Response QR.");
    };

    // Scan HELLO from photo
    scanHelloPhotoBtn.onclick = () => {
      helloFile.value = "";
      helloFile.click();
    };

    helloFile.addEventListener("change", async () => {
      try {
        setStatus("Reading HELLO photo…");
        const text = await scanFromPhoto(helloFile.files[0]);
        setStatus("HELLO decoded. Creating response…");
        await handleHello(text);
      } catch (e) {
        log("HELLO photo scan error:", String(e));
        setStatus("Could not read HELLO from photo.");
      }
    });

    // Scan Response from photo
    scanResponsePhotoBtn.onclick = () => {
      responseFile.value = "";
      responseFile.click();
    };

    responseFile.addEventListener("change", async () => {
      try {
        setStatus("Reading Response photo…");
        const text = await scanFromPhoto(responseFile.files[0]);
        setStatus("Response decoded. Verifying…");
        await handleResponse(text);
      } catch (e) {
        log("Response photo scan error:", String(e));
        setStatus("Could not read Response from photo.");
      }
    });

    (async () => {
      await listCameras();
      const helloFromHash = tryParseHelloFromUrlHash();
      if (helloFromHash) {
        currentHello = helloFromHash;
        setStatus("HELLO detected in URL. Tap Start Scanner OR Scan HELLO Photo.");
      } else {
        setStatus("Ready. Tap Start Scanner or Scan HELLO Photo.");
      }
    })();
  </script>
</body>
</html>
