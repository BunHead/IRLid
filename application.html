<!DOCTYPE html>
<!-- Deploy 15 -->
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>IRLid — Scan</title>
  <link rel="stylesheet" href="css/style.css">

  <style>
    :root{
      --black:#000;
      --white:#fff;
      --mobile-nav-h:124px;
      --side-pad:12px;
      --top-gap:10px;
    }

    html,body{height:100%;}
    body{margin:0;background:#fff;overflow-x:hidden;}

    header.site-header{width:100%;background:#fff;}
    .brand-wrap{padding:10px 14px 0;}
    .brand{display:inline-flex;text-decoration:none;color:inherit;}

    nav.site-nav{
      width:100%;
      background:#000;
      display:flex;
      position:sticky;
      top:0;
      z-index:1000;
    }

    a.nav-btn,summary.nav-btn{
      border:0;
      background:#000;
      color:#fff;
      padding:10px 14px;
      font-weight:700;
      border-radius:0;
      text-decoration:none;
      display:flex;
      align-items:center;
      justify-content:center;
    }

    details.nav-dropdown{position:relative;}
    details.nav-dropdown>summary{list-style:none;}
    details.nav-dropdown>summary::-webkit-details-marker{display:none;}

    .dropdown-menu{
      position:absolute;
      top:100%;
      left:0;
      background:#fff;
      border:1px solid #ddd;
      min-width:220px;
    }
    .dropdown-menu a{
      display:block;
      padding:12px;
      font-weight:700;
      color:#000;
      text-decoration:none;
    }

    main.page-main{
      max-width:980px;
      margin:0 auto;
      padding:var(--top-gap) var(--side-pad) 20px;
      box-sizing:border-box;
    }

    #scanner{
      width:min(92vw,460px);
      height:min(92vw,460px);
      margin:14px auto 8px;
      border:2px dashed #999;
      display:flex;
      align-items:center;
      justify-content:center;
    }

    .controls{
      display:flex;
      gap:10px;
      justify-content:center;
      flex-wrap:wrap;
      margin:10px 0;
    }

    .small{text-align:center;}

    #responseArea{
      display:none;
      text-align:center;
      margin-top:12px;
    }

    /* Debug hidden by default */
    #debug{
      display:none;
      white-space:pre-wrap;
      font-family:monospace;
      font-size:12px;
      border:1px solid #ddd;
      padding:10px;
      margin-top:12px;
    }

    @media(max-width:720px){
      nav.site-nav{
        position:fixed;
        bottom:env(safe-area-inset-bottom,0);
        left:0;right:0;
        height:var(--mobile-nav-h);
        display:grid;
        grid-template-columns:1fr 1fr;
        grid-template-rows:1fr 1fr;
      }
      a.nav-btn,summary.nav-btn{
        width:100%;
        height:100%;
        padding:0;
        font-size:18px;
      }
      .dropdown-menu{
        position:fixed;
        left:0;right:0;
        bottom:calc(var(--mobile-nav-h) + env(safe-area-inset-bottom,0));
      }
      body{
        padding-bottom:calc(var(--mobile-nav-h) + env(safe-area-inset-bottom,0));
      }
    }
  </style>
</head>

<body>

<header class="site-header">
  <div class="brand-wrap">
    <a class="brand" href="index.html">
      <img src="logo.png" alt="IRLid Logo" id="logo">
    </a>
  </div>

  <nav class="site-nav">
    <a class="nav-btn" href="index.html">Home</a>
    <a class="nav-btn" href="application.html">Scan</a>

    <details class="nav-dropdown">
      <summary class="nav-btn">About ▼</summary>
      <div class="dropdown-menu">
        <a href="about.html">About</a>
        <a href="features.html">Features</a>
        <a href="contact.html">Contact</a>
      </div>
    </details>

    <a class="nav-btn" href="receipt.html">Receipts</a>
  </nav>
</header>

<main class="page-main">

  <p id="status" class="small">Ready.</p>

  <div class="controls">
    <button class="btn" id="startBtn">Start Scanner</button>
    <button class="btn secondary" id="stopBtn">Stop</button>
  </div>

  <div id="scanner"></div>

  <div class="small">
    <label for="cameraSelect"><b>Camera:</b></label><br>
    <select id="cameraSelect"></select>
  </div>

  <div id="responseArea">
    <h3>Your Response QR</h3>
    <div id="responseQr"></div>
    <div class="controls">
      <button class="btn secondary" id="scanResponseBtn">Scan Their Response</button>
    </div>
  </div>

  <div id="debug"></div>
</main>

<script src="js/sign.js"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
<script src="https://unpkg.com/html5-qrcode"></script>
<script src="js/qr.js?v=layout8"></script>

<script>
const debugMode = new URLSearchParams(location.search).get("debug") === "1";
const debugEl = document.getElementById("debug");
if (debugMode) debugEl.style.display = "block";

function log(...args){
  if (!debugMode) return;
  debugEl.textContent += "\n" + args.join(" ");
}

async function sha256(data){
  return crypto.subtle.digest("SHA-256", data);
}

async function signBytes(hashBuf){
  const priv = await getPrivateKey();
  const sig = await crypto.subtle.sign(
    { name:"ECDSA", hash:"SHA-256" },
    priv,
    hashBuf
  );
  return b64urlEncode(new Uint8Array(sig));
}

const statusEl = document.getElementById("status");
const cameraSelect = document.getElementById("cameraSelect");
const responseArea = document.getElementById("responseArea");

let scanner=null;

function setStatus(s){statusEl.textContent=s;}

async function listCameras(){
  const devices = await Html5Qrcode.getCameras();
  cameraSelect.innerHTML="";
  devices.forEach((d,i)=>{
    const opt=document.createElement("option");
    opt.value=d.id;
    opt.textContent=d.label||`Camera ${i+1}`;
    cameraSelect.appendChild(opt);
  });

  const rear = devices.findIndex(d=>/(back|rear|environment)/i.test(d.label||""));
  if(rear>=0) cameraSelect.selectedIndex=rear;
}

async function startScanner(handler){
  scanner=new Html5Qrcode("scanner");
  const cam=cameraSelect.value||{facingMode:{ideal:"environment"}};
  await scanner.start(cam,{fps:10,qrbox:320},handler);
}

async function stopScanner(){
  if(!scanner)return;
  await scanner.stop();
  await scanner.clear();
  scanner=null;
}

function decodePayload(text){
  try{
    const bytes=b64urlDecode(text);
    return JSON.parse(new TextDecoder().decode(bytes));
  }catch{return null;}
}

async function handleResponse(text){
  const obj=decodePayload(text);
  if(!obj||obj.type!=="response"){
    setStatus("Not a response QR.");
    return;
  }
  localStorage.setItem("irlid_last_receipt",JSON.stringify(obj));
  setStatus("Saved. Open Receipts.");
  await stopScanner();
}

async function handleHello(text){
  const obj=decodePayload(text);

  if(obj && obj.type==="response"){
    await handleResponse(text);
    return;
  }

  if(!obj||obj.type!=="hello"){
    setStatus("Not a HELLO QR.");
    return;
  }

  const myPub=await getPublicJwk();
  const payload={
    v:1,type:"meeting",
    pubs:[myPub,obj.pub],
    ts:Math.floor(Date.now()/1000)
  };

  const bytes=new TextEncoder().encode(JSON.stringify(payload));
  const hash=await sha256(bytes);
  const sig=await signBytes(hash);

  const response={
    v:1,type:"response",
    payload,
    hash:b64urlEncode(new Uint8Array(hash)),
    sig,
    pub:myPub
  };

  const encoded=b64urlEncode(new TextEncoder().encode(JSON.stringify(response)));
  makeQR("responseQr",encoded,360);

  responseArea.style.display="block";
  setStatus("Show your Response QR.");
  await stopScanner();
}

document.getElementById("startBtn").onclick=async()=>{
  setStatus("Scanning...");
  await startScanner(handleHello);
};

document.getElementById("stopBtn").onclick=stopScanner;
document.getElementById("scanResponseBtn").onclick=async()=>{
  setStatus("Scan their Response QR.");
  await startScanner(handleResponse);
};

listCameras();
</script>

</body>
</html>
