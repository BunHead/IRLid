<!DOCTYPE html>
<html lang="en">
  <!-- Deploy 5 -->
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>IRLid – Application</title>

  <link rel="stylesheet" href="css/style.css">

  <style>
    #scanner {
      width: 420px;
      height: 420px;
      margin: 16px auto;
      border: 2px dashed #999;
      border-radius: 12px;
      overflow: hidden;
      background: #f8f8f8;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    #debug {
      max-width: 980px;
      margin: 12px auto 24px;
      white-space: pre-wrap;
      font-family: ui-monospace, monospace;
      font-size: 12px;
      border: 1px solid #ddd;
      padding: 10px;
      border-radius: 10px;
      background: #fff;
    }
    .small { max-width: 980px; margin: 10px auto; padding: 0 12px; }
    #responseArea { display:none; max-width: 980px; margin: 0 auto; text-align:center; }
    select { padding: 8px; margin: 6px 0; }
    .hint {
      max-width: 980px;
      margin: 8px auto;
      padding: 10px;
      border-radius: 10px;
      background: #f3f7ff;
      border: 1px solid #d6e4ff;
      font-size: 14px;
    }
  </style>
</head>

<body>
<header>
  <img src="logo.png" alt="IRLid Logo" id="logo">
  <nav>
    <ul class="navbar">
      <li><a href="index.html">Home</a></li>
      <li><a href="application.html">Application</a></li>
      <li><a href="receipt.html">Receipt</a></li>
    </ul>
  </nav>
</header>

<main>
  <h2>Application (Mutual Scan + GPS)</h2>

  <div class="hint">
    <b>Desktop webcam tips:</b><br>
    • Make the other person’s QR fill the phone screen<br>
    • Hold it close until it’s sharp<br>
    • Keep QR inside the dashed box
  </div>

  <p class="small" id="status">
    Step 1: Start camera and scan the other person’s Home QR.
  </p>

  <div class="small">
    <label><b>Camera:</b></label><br>
    <select id="cameraSelect"></select><br>
    <button class="btn" id="startBtn">Start Camera</button>
    <button class="btn secondary" id="stopBtn">Stop</button>
  </div>

  <div id="scanner">
    <span>Camera preview</span>
  </div>

  <div id="responseArea">
    <h3>Your Response QR</h3>
    <div class="qr-box" id="responseQr"></div>
  </div>

  <div id="debug"></div>
</main>

<footer>
  IRLid — Proof of Personhood (Demo)
</footer>

<script src="js/sign.js"></script>
<script src="js/qr.js"></script>
<script src="https://unpkg.com/html5-qrcode"></script>

<script>
  const statusEl = document.getElementById("status");
  const debugEl = document.getElementById("debug");
  const cameraSelect = document.getElementById("cameraSelect");
  const startBtn = document.getElementById("startBtn");
  const stopBtn = document.getElementById("stopBtn");
  const responseArea = document.getElementById("responseArea");

  let qr = null;
  let running = false;

  function log(...a) { debugEl.textContent += a.join(" ") + "\n"; }
  function setStatus(t) { statusEl.textContent = t; log(t); }

  async function stopCam() {
    if (qr && running) {
      await qr.stop();
      await qr.clear();
    }
    running = false;
    qr = null;
  }

  function pickRearCamera(cams) {
    for (const c of cams) {
      const l = (c.label || "").toLowerCase();
      if (l.includes("back") || l.includes("rear") || l.includes("environment")) {
        return c.id;
      }
    }
    return cams[cams.length - 1]?.id;
  }

  async function listCameras() {
    const cams = await Html5Qrcode.getCameras();
    cameraSelect.innerHTML = "";

    let defaultId = pickRearCamera(cams);

    cams.forEach(c => {
      const o = document.createElement("option");
      o.value = c.id;
      o.textContent = c.label || c.id;
      if (c.id === defaultId) o.selected = true;
      cameraSelect.appendChild(o);
    });

    return defaultId;
  }

  async function startScan(deviceId) {
    await stopCam();

    qr = new Html5Qrcode("scanner");
    running = true;

    await qr.start(
      { deviceId: { exact: deviceId } },
      {
        fps: 10,
        qrbox: { width: 300, height: 300 },
        disableFlip: false,
        videoConstraints: {
          deviceId: { exact: deviceId },
          width: { ideal: 1920 },
          height: { ideal: 1080 },
          frameRate: { ideal: 30 }
        }
      },
      async (text) => {
        await stopCam();
        await handleHello(text);
      }
    );

    setStatus("Camera started (rear-facing if available). Scanning…");
  }

  async function handleHello(text) {
    const raw = text.includes("HELLO=") ? text.split("HELLO=")[1] : text;
    const hello = JSON.parse(new TextDecoder().decode(b64urlDecode(raw)));

    const myPub = await getPublicJwk();
    const [a, b] = JSON.stringify(myPub) < JSON.stringify(hello.pub)
      ? [myPub, hello.pub]
      : [hello.pub, myPub];

    const payload = { v:1, type:"meeting", a, b, t:Math.floor(Date.now()/1000) };
    const mid = b64urlEncode(await sha256Bytes(canonical(payload)));
    const sig = await signMid(mid);

    const ctx = await new Promise(r =>
      navigator.geolocation.getCurrentPosition(p =>
        r({ lat:p.coords.latitude, lng:p.coords.longitude, ts:Date.now()/1000 })
      )
    );

    const response = { payload, mid, sig, ctx };
    const encoded = b64urlEncode(new TextEncoder().encode(JSON.stringify(response)));

    responseArea.style.display = "block";
    makeQR("responseQr", encoded, 600);
    setStatus("Response QR ready.");
  }

  startBtn.onclick = async () => {
    const defaultId = await listCameras();
    startScan(cameraSelect.value || defaultId);
  };

  stopBtn.onclick = stopCam;

  cameraSelect.onchange = () => {
    if (running) startScan(cameraSelect.value);
  };
</script>
</body>
</html>
