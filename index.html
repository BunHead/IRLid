<!DOCTYPE html>
<!-- Deploy 15 -->
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>IRLid — Proof of Personhood</title>
  <link rel="stylesheet" href="css/style.css">

  <style>
    :root{
      --black:#000;
      --white:#fff;
      --mobile-nav-h:124px;
      --side-pad:12px;
      --qr-top-gap:6px;
    }

    html,body{height:100%;}
    body{margin:0;background:#fff;overflow-x:hidden;}

    header.site-header{width:100%;background:#fff;}
    .brand-wrap{width:100%;padding:8px 14px 0;}
    .brand{display:inline-flex;align-items:center;text-decoration:none;color:inherit;}

    nav.site-nav{
      width:100%;
      background:var(--black);
      display:flex;
      gap:0;
      padding:0;
      margin:0;
      position:sticky;
      top:0;
      z-index:1000;
    }

    a.nav-btn,summary.nav-btn{
      border:0;
      background:var(--black);
      color:#fff;
      text-decoration:none;
      font-weight:700;
      padding:10px 12px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      border-radius:0;
      cursor:pointer;
    }

    details.nav-dropdown{position:relative;}
    details.nav-dropdown>summary{list-style:none;}
    details.nav-dropdown>summary::-webkit-details-marker{display:none;}

    .dropdown-menu{
      position:absolute;
      top:100%;
      left:0;
      background:#fff;
      border:1px solid #ddd;
      min-width:220px;
      padding:0;
    }
    .dropdown-menu a{
      display:block;
      padding:12px;
      font-weight:700;
      text-decoration:none;
      color:#000;
    }

    main.home-main{
      padding:var(--qr-top-gap) var(--side-pad) 0;
      display:flex;
      justify-content:center;
      align-items:flex-start;
    }

    .qr-box{
      width:100%;
      max-width:720px;
    }

    @media (max-width:720px){
      #logo{
        max-width:72vw;
        max-height:90px;
        display:block;
      }

      nav.site-nav{
        position:fixed;
        bottom:env(safe-area-inset-bottom,0px);
        left:0;
        right:0;
        height:var(--mobile-nav-h);
        display:grid;
        grid-template-columns:1fr 1fr;
        grid-template-rows:1fr 1fr;
      }

      a.nav-btn,summary.nav-btn{
        width:100%;
        height:100%;
        padding:0;
        font-size:18px;
      }

      .dropdown-menu{
        position:fixed;
        left:0;
        right:0;
        bottom:calc(var(--mobile-nav-h) + env(safe-area-inset-bottom,0px));
      }

      body{
        padding-bottom:calc(var(--mobile-nav-h) + env(safe-area-inset-bottom,0px));
      }

      main.home-main{
        min-height:calc(100vh - var(--mobile-nav-h));
      }
    }
  </style>
</head>

<body>

<header class="site-header">
  <div class="brand-wrap">
    <a class="brand" href="index.html" aria-label="IRLid Home">
      <img src="logo.png" alt="IRLid Logo" id="logo">
    </a>
  </div>

  <nav class="site-nav" aria-label="Primary">
    <a class="nav-btn" href="index.html">Home</a>
    <a class="nav-btn" href="application.html">Scan</a>
    <details class="nav-dropdown">
      <summary class="nav-btn">About ▼</summary>
      <div class="dropdown-menu" role="menu" aria-label="About menu">
        <a href="about.html">About</a>
        <a href="features.html">Features</a>
        <a href="contact.html">Contact</a>
      </div>
    </details>
    <a class="nav-btn" href="receipt.html">Receipts</a>
  </nav>
</header>

<main class="home-main">
  <div class="qr-box" id="myQr" aria-label="Your IRLid HELLO QR"></div>
</main>

<script src="js/sign.js"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
<script src="js/qr.js?v=deploy9"></script>

<script>
  function computeQrSize(){
    const box=document.getElementById("myQr");
    const boxW=box.clientWidth||window.innerWidth-24;
    const headerH=document.querySelector("header").offsetHeight||0;
    const navH=document.querySelector("nav").offsetHeight||0;
    const viewportH=window.visualViewport?window.visualViewport.height:window.innerHeight;
    const availH=viewportH-headerH-navH-16;
    return Math.max(240,Math.floor(Math.min(boxW,availH)));
  }

  function pubToXY(pubJwk){
    // Compact representation for QR density reduction
    return { x: pubJwk.x, y: pubJwk.y };
  }

  async function renderHelloQr(){
    const pub = await getPublicJwk();

    // Compact HELLO (v2)
    const hello = {
      v: 2,
      t: "h",
      p: pubToXY(pub),
      n: crypto.getRandomValues(new Uint32Array(1))[0],
      ts: Math.floor(Date.now() / 1000)
    };

    const enc = b64urlEncode(new TextEncoder().encode(JSON.stringify(hello)));

    // Absolute URL so phone Camera app can open it
    const base = `${location.origin}${location.pathname.replace(/\/[^\/]*$/, "")}`;
    const url = `${base}/application.html#HELLO=${enc}`;

    makeQR("myQr", url, computeQrSize());
  }

  renderHelloQr();

  const rerender = () => {
    clearTimeout(window.__irlid_qr_t);
    window.__irlid_qr_t = setTimeout(renderHelloQr, 120);
  };
  window.addEventListener("resize", rerender);
  window.addEventListener("orientationchange", rerender);
  if (window.visualViewport) {
    window.visualViewport.addEventListener("resize", rerender);
    window.visualViewport.addEventListener("scroll", rerender);
  }
</script>

</body>
</html>
