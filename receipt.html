<!DOCTYPE html>
<!-- Deploy 20 -->
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>IRLid — Receipts</title>
  <link rel="stylesheet" href="css/style.css">

  <style>
    :root{
      --black:#000;
      --white:#fff;
      --mobile-nav-h: 124px;
      --side-pad: 12px;
      --top-gap: 10px;
    }

    html, body{ height:100%; }
    body{
      margin:0;
      background:#fff;
      overflow-x:hidden;
    }

    header.site-header{ width:100%; background:#fff; }
    .brand-wrap{ width:100%; padding:10px 14px 0 14px; }
    .brand{ display:inline-flex; align-items:center; text-decoration:none; color:inherit; }

    nav.site-nav{
      width:100%;
      background:var(--black);
      display:flex;
      align-items:center;
      justify-content:flex-start;
      gap:0;
      padding:0;
      margin:0;
      position:sticky;
      top:0;
      z-index:1000;
    }

    a.nav-btn, summary.nav-btn{
      appearance:none; -webkit-appearance:none;
      border:0;
      background:var(--black);
      color:var(--white);
      text-decoration:none;
      font:inherit;
      font-weight:700;
      border-radius:0;
      margin:0;
      padding:10px 12px;
      line-height:1;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      user-select:none;
      white-space:nowrap;
    }
    a.nav-btn:hover, summary.nav-btn:hover{ background:#111; }

    details.nav-dropdown{ position:relative; }
    details.nav-dropdown > summary{ list-style:none; }
    details.nav-dropdown > summary::-webkit-details-marker{ display:none; }

    .dropdown-menu{
      position:absolute;
      top:100%;
      left:0;
      background:#fff;
      border:1px solid #ddd;
      border-radius:0;
      padding:0;
      min-width:220px;
      z-index:1200;
    }
    .dropdown-menu a{
      display:block;
      padding:12px 12px;
      text-decoration:none;
      color:#000;
      font-weight:700;
      border-radius:0;
      margin:0;
    }
    .dropdown-menu a:hover{ background:#f2f2f2; }

    main.page-main{
      max-width: 980px;
      margin: 0 auto;
      padding: var(--top-gap) var(--side-pad) 22px var(--side-pad);
      box-sizing:border-box;
    }

    .receipt-wrap{
      width:100%;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:flex-start;
      gap: 12px;
      padding-top: 6px;
    }

    .qr-box{
      width: min(92vw, 520px);
      max-width: 520px;
      box-sizing:border-box;
    }
    .qr-box canvas, .qr-box img{
      display:block;
      margin:0 auto;
      max-width:100%;
      height:auto;
      image-rendering: pixelated;
    }

    .panel{
      width: min(92vw, 720px);
      max-width: 720px;
      box-sizing:border-box;
      border: 1px solid #ddd;
      padding: 12px;
      background: #fff;
    }

    .panel h3{ margin: 0 0 8px 0; }
    .row{ margin: 6px 0; font-weight: 700; }
    .note{ font-size: 13px; font-weight: 600; opacity: 0.85; margin-top: 2px; }

    a.maplink{
      color:#000;
      text-decoration: underline;
      font-weight: 800;
    }

    .checks{ margin-top: 10px; }
    .check{
      display:flex;
      align-items:flex-start;
      gap:10px;
      margin: 8px 0;
      font-weight: 700;
    }
    .badge{
      min-width: 54px;
      text-align:center;
      border: 1px solid #000;
      padding: 2px 6px;
      font-weight: 900;
    }
    .pass{ background:#eaffea; }
    .fail{ background:#ffecec; }

    details.raw{
      width: min(92vw, 720px);
      max-width: 720px;
      box-sizing:border-box;
      margin-top: 6px;
      border: 1px solid #ddd;
      border-radius: 0;
      padding: 0;
      background: #fff;
    }
    details.raw > summary{
      cursor:pointer;
      padding: 10px 12px;
      font-weight: 800;
      list-style:none;
    }
    details.raw > summary::-webkit-details-marker{ display:none; }

    pre{
      margin:0;
      padding: 10px 12px;
      border-top: 1px solid #ddd;
      white-space: pre-wrap;
      word-break: break-word;
      font-family: ui-monospace, monospace;
      font-size: 12px;
      background:#fff;
    }

    .btnrow{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top:10px;
      justify-content:center;
    }

    @media (max-width:720px){
      :root{ --top-gap: 6px; }

      .brand-wrap{ padding:4px var(--side-pad) 0 var(--side-pad); }
      #logo{
        max-width:72vw;
        max-height:90px;
        width:auto; height:auto;
        display:block;
      }

      nav.site-nav{
        position:fixed;
        top:auto;
        bottom: env(safe-area-inset-bottom, 0px);
        left:0; right:0;
        height: var(--mobile-nav-h);
        display:grid;
        grid-template-columns:1fr 1fr;
        grid-template-rows:1fr 1fr;
        gap:0;
        margin:0;
        padding:0;
        background:var(--black);
        z-index:2000;
      }

      a.nav-btn, summary.nav-btn{
        width:100%;
        height:100%;
        padding:0;
        font-size:18px;
      }

      .dropdown-menu{
        position:fixed;
        left:0; right:0;
        bottom: calc(var(--mobile-nav-h) + env(safe-area-inset-bottom, 0px));
        top:auto;
      }

      body{
        padding-bottom: calc(var(--mobile-nav-h) + env(safe-area-inset-bottom, 0px));
      }
    }
  </style>
</head>

<body>
  <header class="site-header">
    <div class="brand-wrap">
      <a class="brand" href="index.html" aria-label="IRLid Home">
        <img src="logo.png" alt="IRLid Logo" id="logo">
      </a>
    </div>

    <nav class="site-nav" aria-label="Primary">
      <a class="nav-btn" href="index.html">Home</a>
      <a class="nav-btn" href="application.html">Scan</a>

      <details class="nav-dropdown">
        <summary class="nav-btn">About ▼</summary>
        <div class="dropdown-menu" role="menu" aria-label="About menu">
          <a href="about.html">About</a>
          <a href="features.html">Features</a>
          <a href="contact.html">Contact</a>
        </div>
      </details>

      <a class="nav-btn" href="receipt.html">Receipts</a>
    </nav>
  </header>

  <main class="page-main">
    <div class="receipt-wrap">

      <div class="panel" id="emptyState" style="display:none;">
        No receipts yet. Use <a href="application.html">Scan</a> to exchange return QRs.
      </div>

      <div class="qr-box" id="topQr" aria-label="Receipt QR"></div>

      <div class="panel" id="metaPanel" style="display:none;">
        <h3 id="metaTitle">Receipt</h3>
        <div class="row" id="coordsRow"></div>
        <div class="row" id="timeRow"></div>
        <div class="note" id="accRow"></div>

        <div class="checks" id="checks"></div>

        <div class="btnrow">
          <button class="btn secondary" id="clearBtn">Clear stored receipts</button>
        </div>

        <div class="note" style="margin-top:10px;">
          Tip: the QR above is a URL. Any QR scanner can open this receipt page on IRLid.
        </div>
      </div>

      <details class="raw" id="rawWrap" style="display:none;">
        <summary>Show stored JSON</summary>
        <pre id="rawJson"></pre>
      </details>

    </div>
  </main>

  <script src="js/sign.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
  <script src="js/qr.js?v=deploy19"></script>

  <script>
    // thresholds (requested)
    const TS_TOL_S = 60;
    const DIST_TOL_M = 2;

    const KEY_SELF  = "irlid_resp_self";
    const KEY_OTHER = "irlid_resp_other";
    const KEY_LAST  = "irlid_last_receipt"; // legacy
    const KEY_LIST  = "irlid_receipts";     // history for future "login"

    const emptyState = document.getElementById("emptyState");
    const metaPanel = document.getElementById("metaPanel");
    const metaTitle = document.getElementById("metaTitle");
    const coordsRow = document.getElementById("coordsRow");
    const timeRow = document.getElementById("timeRow");
    const accRow = document.getElementById("accRow");
    const checksEl = document.getElementById("checks");
    const rawWrap = document.getElementById("rawWrap");
    const rawJson = document.getElementById("rawJson");
    const clearBtn = document.getElementById("clearBtn");

    function fmtNum(n){
      if (typeof n !== "number") return "";
      return n.toFixed(6);
    }

    function formatTime(ts){
      if (!ts || typeof ts !== "number") return null;
      const d = new Date(ts * 1000);
      return { local: d.toLocaleString(), iso: d.toISOString(), epoch: ts, date: d };
    }

    function haversineMeters(lat1, lon1, lat2, lon2){
      const R = 6371000;
      const toRad = (x) => x * Math.PI / 180;
      const dLat = toRad(lat2 - lat1);
      const dLon = toRad(lon2 - lon1);
      const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return R * c;
    }

    function addCheck(label, ok, detail){
      const div = document.createElement("div");
      div.className = "check";
      const badge = document.createElement("div");
      badge.className = "badge " + (ok ? "pass" : "fail");
      badge.textContent = ok ? "PASS" : "FAIL";
      const txt = document.createElement("div");
      txt.innerHTML = `${label}${detail ? `<div class="note">${detail}</div>` : ""}`;
      div.appendChild(badge);
      div.appendChild(txt);
      checksEl.appendChild(div);
    }

    function readJson(key){
      const raw = localStorage.getItem(key);
      if (!raw) return null;
      try { return JSON.parse(raw); } catch { return null; }
    }

    function writeReceiptHistory(combinedObj){
      // Store a small summary + full combined object for future "member receipts".
      try {
        const listRaw = localStorage.getItem(KEY_LIST);
        const list = listRaw ? JSON.parse(listRaw) : [];
        const entry = {
          ts: Date.now(),
          combined: combinedObj
        };
        list.unshift(entry);
        // cap to avoid infinite growth
        const capped = list.slice(0, 200);
        localStorage.setItem(KEY_LIST, JSON.stringify(capped));
      } catch {}
    }

    async function validateResponse(resp){
      const results = {
        okStructure: false,
        okHash: false,
        okSig: false,
        computedHash: null
      };

      if (!resp || resp.type !== "response" || !resp.payload || !resp.hash || !resp.sig || !resp.pub) {
        return results;
      }
      results.okStructure = true;

      try {
        const computed = await hashPayloadToB64url(resp.payload);
        results.computedHash = computed;
        results.okHash = (computed === resp.hash);
      } catch {
        results.okHash = false;
      }

      try {
        results.okSig = await verifySig(resp.hash, resp.sig, resp.pub);
      } catch {
        results.okSig = false;
      }

      return results;
    }

    function getGps(resp){
      const gps = resp && resp.payload ? resp.payload.gps : null;
      if (!gps) return null;
      if (typeof gps.lat !== "number" || typeof gps.lon !== "number") return null;
      return gps;
    }

    function getTs(resp){
      const ts = resp && resp.payload ? resp.payload.ts : null;
      return (typeof ts === "number") ? ts : null;
    }

    function baseReceiptUrl(){
      return new URL("receipt.html", location.href).href.split("#")[0];
    }

    function makeReceiptUrlForCombined(combinedObj){
      const encoded = b64urlEncode(new TextEncoder().encode(JSON.stringify(combinedObj)));
      return `${baseReceiptUrl()}#COMB=${encoded}`;
    }

    function makeReceiptUrlForResponse(respObj){
      const encoded = b64urlEncode(new TextEncoder().encode(JSON.stringify(respObj)));
      return `${baseReceiptUrl()}#RESP=${encoded}`;
    }

    function parseFromHash(){
      const hash = location.hash || "";
      let m = hash.match(/COMB=([A-Za-z0-9\-_]+)/);
      if (m) {
        try {
          const bytes = b64urlDecode(m[1]);
          return { kind: "comb", obj: JSON.parse(new TextDecoder().decode(bytes)) };
        } catch {}
      }
      m = hash.match(/RESP=([A-Za-z0-9\-_]+)/);
      if (m) {
        try {
          const bytes = b64urlDecode(m[1]);
          return { kind: "resp", obj: JSON.parse(new TextDecoder().decode(bytes)) };
        } catch {}
      }
      return null;
    }

    function combinedObject(selfResp, otherResp){
      return {
        v: 1,
        type: "combined",
        tol: { dist_m: DIST_TOL_M, ts_s: TS_TOL_S },
        a: selfResp,
        b: otherResp
      };
    }

    clearBtn.onclick = () => {
      localStorage.removeItem(KEY_SELF);
      localStorage.removeItem(KEY_OTHER);
      localStorage.removeItem(KEY_LAST);
      localStorage.removeItem(KEY_LIST);
      // keep URL hash, but refresh view
      location.href = baseReceiptUrl();
    };

    (async () => {
      // If opened from an external QR scanner (URL QR), import it into localStorage.
      const fromHash = parseFromHash();
      if (fromHash && fromHash.kind === "resp" && fromHash.obj && fromHash.obj.type === "response") {
        // Store as "last" for compatibility; user can later pair it by scanning the other side.
        localStorage.setItem(KEY_LAST, JSON.stringify(fromHash.obj));
      }
      if (fromHash && fromHash.kind === "comb" && fromHash.obj && fromHash.obj.type === "combined") {
        // Store combined into history (future login/list)
        writeReceiptHistory(fromHash.obj);
      }

      const selfResp  = readJson(KEY_SELF);
      const otherResp = readJson(KEY_OTHER);
      const legacy    = readJson(KEY_LAST);

      const havePair = !!(selfResp && otherResp);
      const single = selfResp || otherResp || legacy;

      if (!havePair && !single && !(fromHash && fromHash.kind === "comb")) {
        emptyState.style.display = "block";
        return;
      }

      metaPanel.style.display = "block";
      rawWrap.style.display = "block";

      // Decide top QR:
      // - If combined URL hash exists, show that combined
      // - Else if both responses exist: show combined
      // - Else show a URL QR for the single response
      if (fromHash && fromHash.kind === "comb" && fromHash.obj && fromHash.obj.type === "combined") {
        metaTitle.textContent = "Combined Receipt (Opened via QR)";
        const url = makeReceiptUrlForCombined(fromHash.obj);
        makeQR("topQr", url, 460);
        rawJson.textContent = JSON.stringify(fromHash.obj, null, 2);
        // Basic info from combined.a if present
        const base = fromHash.obj.a || fromHash.obj.b || null;
        const gps = base ? getGps(base) : null;
        const ts = base ? getTs(base) : null;

        if (gps) {
          const q = `${gps.lat},${gps.lon}`;
          const mapsUrl = `https://www.google.com/maps?q=${encodeURIComponent(q)}`;
          coordsRow.innerHTML = `Location: <a class="maplink" href="${mapsUrl}" target="_blank" rel="noopener noreferrer">${fmtNum(gps.lat)}, ${fmtNum(gps.lon)}</a>`;
          accRow.textContent = (typeof gps.acc === "number") ? `Accuracy: ±${Math.round(gps.acc)} m` : "";
        } else {
          coordsRow.textContent = "Location: (not captured)";
          accRow.textContent = "";
        }
        const t = formatTime(ts);
        timeRow.textContent = t ? `Time: ${t.local} (ts: ${t.epoch})` : "Time: (missing)";

        checksEl.innerHTML = "";
        addCheck("Combined receipt loaded from URL", true, "This is ready for future account-based receipt history.");
        return;
      }

      if (havePair) {
        metaTitle.textContent = "Combined Receipt (Both Parties)";
        const combined = combinedObject(selfResp, otherResp);

        // Top QR is a URL so any generic QR scanner opens this receipt page.
        const url = makeReceiptUrlForCombined(combined);
        makeQR("topQr", url, 460);

        rawJson.textContent = JSON.stringify({ selfResp, otherResp }, null, 2);

        // Store into history for future "members can view all receipts"
        writeReceiptHistory(combined);
      } else {
        metaTitle.textContent = "Return Receipt (Waiting for the other scan)";
        const url = makeReceiptUrlForResponse(single);
        makeQR("topQr", url, 460);
        rawJson.textContent = JSON.stringify(single, null, 2);
      }

      // Meta based on best available local receipt
      const base = selfResp || otherResp || legacy;
      const gps = getGps(base);
      const ts = getTs(base);

      if (gps) {
        const q = `${gps.lat},${gps.lon}`;
        const mapsUrl = `https://www.google.com/maps?q=${encodeURIComponent(q)}`;
        coordsRow.innerHTML = `Location: <a class="maplink" href="${mapsUrl}" target="_blank" rel="noopener noreferrer">${fmtNum(gps.lat)}, ${fmtNum(gps.lon)}</a>`;
        accRow.textContent = (typeof gps.acc === "number") ? `Accuracy: ±${Math.round(gps.acc)} m` : "";
      } else {
        coordsRow.textContent = "Location: (not captured)";
        accRow.textContent = "";
      }

      const t = formatTime(ts);
      timeRow.textContent = t ? `Time: ${t.local} (ts: ${t.epoch})` : "Time: (missing)";

      // Validation checks
      checksEl.innerHTML = "";

      if (selfResp) {
        const vr = await validateResponse(selfResp);
        addCheck("Self receipt structure", vr.okStructure);
        addCheck("Self hash matches payload", vr.okHash, vr.okHash ? "" : `computed=${vr.computedHash || "?"}`);
        addCheck("Self signature valid", vr.okSig);
      }

      if (otherResp) {
        const vr = await validateResponse(otherResp);
        addCheck("Other receipt structure", vr.okStructure);
        addCheck("Other hash matches payload", vr.okHash, vr.okHash ? "" : `computed=${vr.computedHash || "?"}`);
        addCheck("Other signature valid", vr.okSig);
      }

      if (selfResp && otherResp) {
        const pubsA = (selfResp.payload && selfResp.payload.pubs) ? JSON.stringify(selfResp.payload.pubs) : null;
        const pubsB = (otherResp.payload && otherResp.payload.pubs) ? JSON.stringify(otherResp.payload.pubs) : null;
        const okPubs = (pubsA && pubsB && pubsA === pubsB);
        addCheck("Both receipts refer to the same two public keys (ordered pubs)", okPubs);

        const tsA = getTs(selfResp);
        const tsB = getTs(otherResp);
        const okTs = (typeof tsA === "number" && typeof tsB === "number" && Math.abs(tsA - tsB) <= TS_TOL_S);
        addCheck(`Timestamps within ${TS_TOL_S}s`, okTs, (tsA && tsB) ? `Δt=${Math.abs(tsA-tsB)}s` : "missing ts");

        const gA = getGps(selfResp);
        const gB = getGps(otherResp);
        let okDist = false;
        let dist = null;
        if (gA && gB) {
          dist = haversineMeters(gA.lat, gA.lon, gB.lat, gB.lon);
          okDist = dist <= DIST_TOL_M;
        }
        addCheck(`Distance within ${DIST_TOL_M}m`, okDist, dist !== null ? `Δ=${dist.toFixed(2)}m` : "missing gps");
      } else {
        addCheck("Waiting for both parties (need two receipts)", false, "Have one receipt only. Show the URL QR above to the other person to scan/open.");
      }
    })();
  </script>
</body>
</html>
