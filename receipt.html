<!DOCTYPE html>
<!-- Deploy 16 -->
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>IRLid — Receipts</title>
  <link rel="stylesheet" href="css/style.css">

  <style>
    :root{
      --black:#000;
      --white:#fff;
      --mobile-nav-h: 124px;
      --side-pad: 12px;
      --top-gap: 10px;
    }

    html, body{ height:100%; }
    body{
      margin:0;
      background:#fff;
      overflow-x:hidden;
    }

    /* ===== Header / Desktop nav ===== */
    header.site-header{ width:100%; background:#fff; }
    .brand-wrap{ width:100%; padding:10px 14px 0 14px; }
    .brand{ display:inline-flex; align-items:center; text-decoration:none; color:inherit; }

    nav.site-nav{
      width:100%;
      background:var(--black);
      display:flex;
      align-items:center;
      justify-content:flex-start;
      gap:0;
      padding:0;
      margin:0;
      position:sticky;
      top:0;
      z-index:1000;
    }

    a.nav-btn, summary.nav-btn{
      appearance:none; -webkit-appearance:none;
      border:0;
      background:var(--black);
      color:var(--white);
      text-decoration:none;
      font:inherit;
      font-weight:700;
      border-radius:0;
      margin:0;
      padding:10px 12px;
      line-height:1;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      user-select:none;
      white-space:nowrap;
    }
    a.nav-btn:hover, summary.nav-btn:hover{ background:#111; }

    details.nav-dropdown{ position:relative; }
    details.nav-dropdown > summary{ list-style:none; }
    details.nav-dropdown > summary::-webkit-details-marker{ display:none; }

    .dropdown-menu{
      position:absolute;
      top:100%;
      left:0;
      background:#fff;
      border:1px solid #ddd;
      border-radius:0;
      padding:0;
      min-width:220px;
      z-index:1200;
    }
    .dropdown-menu a{
      display:block;
      padding:12px 12px;
      text-decoration:none;
      color:#000;
      font-weight:700;
      border-radius:0;
      margin:0;
    }
    .dropdown-menu a:hover{ background:#f2f2f2; }

    /* ===== Page layout ===== */
    main.page-main{
      max-width: 980px;
      margin: 0 auto;
      padding: var(--top-gap) var(--side-pad) 22px var(--side-pad);
      box-sizing:border-box;
    }

    .receipt-wrap{
      width:100%;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:flex-start;
      gap: 12px;
      padding-top: 6px;
    }

    .qr-box{
      width: min(92vw, 520px);
      max-width: 520px;
      box-sizing:border-box;
    }
    .qr-box canvas, .qr-box img{
      display:block;
      margin:0 auto;
      max-width:100%;
      height:auto;
      image-rendering: pixelated;
    }

    .meta{
      width: min(92vw, 520px);
      max-width: 520px;
      box-sizing:border-box;
      text-align:center;
    }

    .meta .row{
      margin: 6px 0;
      font-weight:700;
    }

    .meta a{
      color:#000;
      text-decoration: underline;
      font-weight: 800;
    }

    .note{
      font-size: 13px;
      font-weight: 600;
      opacity: 0.85;
      margin-top: 2px;
    }

    /* Hidden raw JSON by default (still accessible) */
    details.raw{
      width: min(92vw, 720px);
      max-width: 720px;
      box-sizing:border-box;
      margin-top: 6px;
      border: 1px solid #ddd;
      border-radius: 0;
      padding: 0;
      background: #fff;
    }
    details.raw > summary{
      cursor:pointer;
      padding: 10px 12px;
      font-weight: 800;
      list-style:none;
    }
    details.raw > summary::-webkit-details-marker{ display:none; }

    pre#rawJson{
      margin:0;
      padding: 10px 12px;
      border-top: 1px solid #ddd;
      white-space: pre-wrap;
      word-break: break-word;
      font-family: ui-monospace, monospace;
      font-size: 12px;
      background:#fff;
    }

    #emptyState{
      width: min(92vw, 720px);
      max-width: 720px;
      border: 1px solid #ddd;
      padding: 12px;
      box-sizing:border-box;
      font-weight: 700;
    }

    /* ===== Mobile bottom 2x2 nav ===== */
    @media (max-width:720px){
      :root{ --top-gap: 6px; }

      .brand-wrap{ padding:4px var(--side-pad) 0 var(--side-pad); }
      #logo{
        max-width:72vw;
        max-height:90px;
        width:auto; height:auto;
        display:block;
      }

      nav.site-nav{
        position:fixed;
        top:auto;
        bottom: env(safe-area-inset-bottom, 0px);
        left:0; right:0;
        height: var(--mobile-nav-h);
        display:grid;
        grid-template-columns:1fr 1fr;
        grid-template-rows:1fr 1fr;
        gap:0;
        margin:0;
        padding:0;
        background:var(--black);
      }

      a.nav-btn, summary.nav-btn{
        width:100%;
        height:100%;
        padding:0;
        font-size:18px;
      }

      .dropdown-menu{
        position:fixed;
        left:0; right:0;
        bottom: calc(var(--mobile-nav-h) + env(safe-area-inset-bottom, 0px));
        top:auto;
      }

      body{
        padding-bottom: calc(var(--mobile-nav-h) + env(safe-area-inset-bottom, 0px));
      }
    }
  </style>
</head>

<body>
  <header class="site-header">
    <div class="brand-wrap">
      <a class="brand" href="index.html" aria-label="IRLid Home">
        <img src="logo.png" alt="IRLid Logo" id="logo">
      </a>
    </div>

    <nav class="site-nav" aria-label="Primary">
      <a class="nav-btn" href="index.html">Home</a>
      <a class="nav-btn" href="application.html">Scan</a>

      <details class="nav-dropdown">
        <summary class="nav-btn">About ▼</summary>
        <div class="dropdown-menu" role="menu" aria-label="About menu">
          <a href="about.html">About</a>
          <a href="features.html">Features</a>
          <a href="contact.html">Contact</a>
        </div>
      </details>

      <a class="nav-btn" href="receipt.html">Receipts</a>
    </nav>
  </header>

  <main class="page-main">
    <div class="receipt-wrap">
      <div id="emptyState" style="display:none;">
        No receipt found yet. Complete the scan flow first in <a href="application.html">Scan</a>.
      </div>

      <div class="qr-box" id="receiptQr" aria-label="Receipt QR"></div>

      <div class="meta" id="meta" style="display:none;">
        <div class="row" id="coordsRow"></div>
        <div class="row" id="timeRow"></div>
        <div class="note" id="accRow"></div>
      </div>

      <details class="raw" id="rawWrap" style="display:none;">
        <summary>Show raw receipt JSON</summary>
        <pre id="rawJson"></pre>
      </details>
    </div>
  </main>

  <script src="js/sign.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
  <script src="js/qr.js?v=layout9"></script>

  <script>
    const emptyState = document.getElementById("emptyState");
    const meta = document.getElementById("meta");
    const coordsRow = document.getElementById("coordsRow");
    const timeRow = document.getElementById("timeRow");
    const accRow = document.getElementById("accRow");
    const rawWrap = document.getElementById("rawWrap");
    const rawJson = document.getElementById("rawJson");

    function fmtNum(n){
      if (typeof n !== "number") return "";
      return n.toFixed(6);
    }

    function formatTime(ts){
      if (!ts || typeof ts !== "number") return null;
      const d = new Date(ts * 1000);
      return {
        local: d.toLocaleString(),
        iso: d.toISOString(),
        epoch: ts
      };
    }

    const raw = localStorage.getItem("irlid_last_receipt");
    if (!raw) {
      emptyState.style.display = "block";
    } else {
      try {
        const obj = JSON.parse(raw);

        // Render QR front and center
        const encoded = b64urlEncode(new TextEncoder().encode(JSON.stringify(obj)));
        makeQR("receiptQr", encoded, 460);

        // Extract metadata
        const gps = obj && obj.payload && obj.payload.gps ? obj.payload.gps : null;
        const ts = obj && obj.payload ? obj.payload.ts : null;

        // Show meta block if we have anything useful
        const hasGps = gps && typeof gps.lat === "number" && typeof gps.lon === "number";
        const t = formatTime(ts);

        if (hasGps || t) meta.style.display = "block";

        if (hasGps) {
          const lat = gps.lat;
          const lon = gps.lon;
          const q = `${lat},${lon}`;

          // Google Maps deep link (pin/search at coords)
          const mapsUrl = `https://www.google.com/maps?q=${encodeURIComponent(q)}`;

          coordsRow.innerHTML =
            `Location: <a href="${mapsUrl}" target="_blank" rel="noopener noreferrer">${fmtNum(lat)}, ${fmtNum(lon)}</a>`;

          if (typeof gps.acc === "number") {
            accRow.textContent = `Accuracy: ±${Math.round(gps.acc)} m`;
          } else {
            accRow.textContent = "";
          }
        } else {
          coordsRow.textContent = "Location: (not captured)";
          accRow.textContent = "";
        }

        if (t) {
          timeRow.textContent = `Time: ${t.local} (ts: ${t.epoch})`;
        } else {
          timeRow.textContent = "Time: (missing)";
        }

        // Keep raw JSON hidden behind details toggle
        rawWrap.style.display = "block";
        rawJson.textContent = JSON.stringify(obj, null, 2);

      } catch (e) {
        emptyState.style.display = "block";
        emptyState.textContent = "Failed to parse receipt. Try scanning again.";
      }
    }
  </script>
</body>
</html>
